<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Heike Hofmann, Di Cook" />

<meta name="date" content="2017-05-24" />

<title>Getting Oz Electorate shapefiles into shape</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Getting Oz Electorate shapefiles into shape</h1>
<h4 class="author"><em>Heike Hofmann, Di Cook</em></h4>
<h4 class="date"><em>2017-05-24</em></h4>


<div id="TOC">
<ul>
<li><a href="#extracting-the-electorate-information">Extracting the electorate information</a></li>
<li><a href="#extracting-the-polygon-information">Extracting the polygon information</a></li>
<li><a href="#getting-centroids">Getting centroids</a></li>
</ul>
</div>

<p>The Australian Electorate Commission publishes the boundaries of the electorates on their website at <a href="http://www.aec.gov.au/Electorates/gis/gis_datadownload.htm" class="uri">http://www.aec.gov.au/Electorates/gis/gis_datadownload.htm</a>.</p>
<p>Once the files (preferably the national files) are downloaded, unzip the file (it will build a folder with a set of files). We want to read the shapes contained in the <code>shp</code> file into R.</p>
<p>For the 2016 election, the national electorate boundaries are given in mapinfo format (<a href="http://www.aec.gov.au/Electorates/gis/files/nt-midmif-07022017.zip" class="uri">http://www.aec.gov.au/Electorates/gis/files/nt-midmif-07022017.zip</a>). The <code>rgdal</code> library can be used to read this format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgdal)
sF &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn=</span><span class="st">&quot;national-midmif-09052016/COM_ELB.TAB&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;COM_ELB&quot;</span>)</code></pre></div>
<p><code>sF</code> is a spatial data frame containing all of the polygons. We use the <code>rmapshaper</code> package available from ateucher’s github page to thin the polygons while preserving the geography:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rmapshaper)</code></pre></div>
<p>If the library is not available, install it from github using <code>devtools::install_github(&quot;ateucher/rmapshaper&quot;)</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sFsmall &lt;-<span class="st"> </span><span class="kw">ms_simplify</span>(sF, <span class="dt">keep=</span><span class="fl">0.05</span>) <span class="co"># use instead of thinnedSpatialPoly</span></code></pre></div>
<p><code>keep</code> indicates the percentage of points we want to keep in the polygons. 5% makes the electorate boundary still quite recognizable, but reduce the overall size of the map considerably, making it faster to plot.</p>
<p>We can use base graphics to plot this map:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(sFsmall)</code></pre></div>
<div id="extracting-the-electorate-information" class="section level3">
<h3>Extracting the electorate information</h3>
<p>A spatial polygons data frame consists of both a data set with information on each of the entities (in this case, electorates), and a set of polygons for each electorate (sometimes multiple polygons are needed, e.g. if the electorate has islands). We want to extract both of these parts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nat_data &lt;-<span class="st"> </span>sF@data
<span class="kw">head</span>(nat_data)</code></pre></div>
<p>The row names of the data file are identifiers corresponding to the polygons - we want to make them a separate variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nat_data$id &lt;-<span class="st"> </span><span class="kw">row.names</span>(nat_data)</code></pre></div>
<p>In the currently published version of the 2013 electorate boundaries, the <code>data</code> data frame has variable <code>ELECT_DIV</code> of the electorates’ names, and variable <code>STATE</code>, which is an abbreviation of the state name. It might be convenient to merge this information (or at least the state abbreviation) into the polygons (see below). We are almost ready to export this data into a file, but we still want include geographic centers in the data (see also below).</p>
</div>
<div id="extracting-the-polygon-information" class="section level3">
<h3>Extracting the polygon information</h3>
<p>The <code>fortify</code> function in the <code>ggplot2</code> package extracts the polygons into a data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nat_map &lt;-<span class="st"> </span>ggplot2::<span class="kw">fortify</span>(sFsmall)
<span class="kw">head</span>(nat_map)</code></pre></div>
<p>We need to make sure that <code>group</code> and <code>piece</code> are kept as factor variables - if they are allowed to be converted to numeric values, it messes things up, because as factor levels <code>9</code> and <code>9.0</code> are distinct, whereas they are not when interpreted as numbers …</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nat_map$group &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;g&quot;</span>,nat_map$group,<span class="dt">sep=</span><span class="st">&quot;.&quot;</span>)
nat_map$piece &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;p&quot;</span>,nat_map$piece,<span class="dt">sep=</span><span class="st">&quot;.&quot;</span>)</code></pre></div>
<p>It is useful to have the electorate name and state attached to the map.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nms &lt;-<span class="st"> </span>sFsmall@data %&gt;%<span class="st"> </span><span class="kw">select</span>(Elect_div, State)
nms$id &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="dv">1</span>:<span class="dv">150</span>)
nat_map &lt;-<span class="st"> </span><span class="kw">left_join</span>(nat_map, nms, <span class="dt">by=</span><span class="st">&quot;id&quot;</span>)</code></pre></div>
<p>The map data is ready to be exported to a file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(nat_map, <span class="st">&quot;National-map-2016.csv&quot;</span>, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="getting-centroids" class="section level3">
<h3>Getting centroids</h3>
<p>Getting centroids or any other information from a polygon is fairly simple, once you have worked your way through the polygon structure. First, we are going to just focus on the polygons themselves:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">polys &lt;-<span class="st"> </span><span class="kw">as</span>(sF, <span class="st">&quot;SpatialPolygons&quot;</span>)
<span class="kw">class</span>(polys) <span class="co"># should be SpatialPolygons</span>
<span class="kw">length</span>(polys) <span class="co"># should be 150</span></code></pre></div>
<p>Because SpatialPolygons are an S4 object, they have so called <code>slots</code>, and in this case the slots are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">slotNames</span>(polys)</code></pre></div>
<p>We are interested further into the polygon aspect of this object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">Polygon</span>(polys[<span class="dv">1</span>])</code></pre></div>
<p>From this, we want to extract the <code>labpt</code> component, because those are the centroids we are interested in. We will wrap this into a little function called <code>centroid</code> to help us with that:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
centroid &lt;-<span class="st"> </span>function(i, polys) {
  ctr &lt;-<span class="st"> </span><span class="kw">Polygon</span>(polys[i])@labpt
  <span class="kw">data.frame</span>(<span class="dt">long_c=</span>ctr[<span class="dv">1</span>], <span class="dt">lat_c=</span>ctr[<span class="dv">2</span>])
}
centroids &lt;-<span class="st"> </span><span class="kw">seq_along</span>(polys) %&gt;%<span class="st"> </span>purrr::<span class="kw">map_df</span>(centroid, <span class="dt">polys=</span>polys)
<span class="kw">head</span>(centroids)</code></pre></div>
<p>The centroids come in the same order as the data (luckily) and we just extend the data set for the electorates by this information, and finally export:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nat_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(nat_data, centroids)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(nat_data, <span class="st">&quot;National-data-2016.csv&quot;</span>, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</code></pre></div>
<p>Finally, just to check the data, a map of the Australian electorates colored by their size as given in the data (variable <code>Area_SqKm</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(ggthemes)
<span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">map_id=</span>id), <span class="dt">data=</span>nat_data) +
<span class="st">  </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>Area_SqKm), <span class="dt">map=</span>nat_map) +
<span class="st">  </span><span class="kw">expand_limits</span>(<span class="dt">x=</span>nat_map$long, <span class="dt">y=</span>nat_map$lat) +<span class="st"> </span>
<span class="st">  </span><span class="kw">theme_map</span>()</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
